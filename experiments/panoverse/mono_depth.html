<!DOCTYPE html>
<html lang="en">
<head>
    <title>Panoverse - Mono with depth</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link type="text/css" rel="stylesheet" href="main.css">
</head>
<body>
    <div id="container"></div>

    <!-- Import maps polyfill -->
    <!-- Remove this when import maps will be widely supported -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>

    
    <script type="module">

	
		import * as THREE from './build/three.module.js';
		import { VRButton } from './jsm/webxr/VRButton.js';

		const mono_image = 'data/mono_depth/0/scene.png';
		const depth_image = 'data/mono_depth/0/depth.png';


        let camera, scene, renderer, sphere, clock;

        init();
        animate();

        function init() {

        const container = document.getElementById( 'container' );

        clock = new THREE.Clock();

        scene = new THREE.Scene();
        scene.background = new THREE.Color( 0x101010 );

        const light = new THREE.AmbientLight( 0xffffff, 1 );
        scene.add( light );

        camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 1, 2000 );
        scene.add( camera );

        // Create the panoramic sphere geometery
        const panoSphereGeo = new THREE.SphereGeometry( 6, 256, 256 );

        // Create the panoramic sphere material
        const panoSphereMat = new THREE.MeshStandardMaterial( {
        side: THREE.BackSide,
        displacementScale: - 4.0
        } );

        // Create the panoramic sphere mesh
        sphere = new THREE.Mesh( panoSphereGeo, panoSphereMat );

        // Load and assign the texture and depth map
        const manager = new THREE.LoadingManager();
        const loader = new THREE.TextureLoader( manager );

        loader.load( mono_image, function ( texture ) {

        texture.colorSpace = THREE.SRGBColorSpace;
        texture.minFilter = THREE.NearestFilter;
        texture.generateMipmaps = false;
        sphere.material.map = texture;

        } );

        loader.load( depth_image, function ( depth ) {

        depth.minFilter = THREE.NearestFilter;
        depth.generateMipmaps = false;
        sphere.material.displacementMap = depth;

        } );

        // On load complete add the panoramic sphere to the scene
        manager.onLoad = function () {

        scene.add( sphere );

        };

        renderer = new THREE.WebGLRenderer();
        renderer.setPixelRatio( window.devicePixelRatio );
        renderer.setSize( window.innerWidth, window.innerHeight );
        renderer.xr.enabled = true;
        renderer.xr.setReferenceSpaceType( 'local' );
        container.appendChild( renderer.domElement );

        document.body.appendChild( VRButton.createButton( renderer ) );

        //

        window.addEventListener( 'resize', onWindowResize );

        }

        function onWindowResize() {

        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize( window.innerWidth, window.innerHeight );

        }

        function animate() {

        renderer.setAnimationLoop( render );
                                                                                                                                                                                                                                                                                                                                                                                                                                        
        }

        function render() {

        // If we are not presenting move the camera a little so the effect is visible

        if ( renderer.xr.isPresenting === false ) {

        const time = clock.getElapsedTime();

        sphere.rotation.y += 0.01;
        sphere.position.x = Math.sin( 2*time ) * 0.3;
        sphere.position.z = Math.cos( 3*time ) * 0.3;

        }

        renderer.render( scene, camera );

        }

    </script>
</body>
</html>
